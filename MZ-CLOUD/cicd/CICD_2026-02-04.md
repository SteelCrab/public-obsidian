# DockerHub/ECR + SSM 배포

#cicd #docker #ecr #ssm #aws #iam

---

```table-of-contents
```

DockerHub/ECR → SSM → EC2 배포 (Nginx, FastAPI)

---

## 1. EC2 + IAM 설정

### EC2 인스턴스 (pista-ubuntu)

[[aws-ec2]]

### IAM 역할 (pista-ec2-ssm-role)

[[aws-iam]]

#### 신뢰할 수 있는 엔터티

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": ["sts:AssumeRole"],
            "Principal": {
                "Service": ["ec2.amazonaws.com"]
            }
        }
    ]
}
```

#### 권한 정책

| 역할 | 필요 정책 |
|------|----------|
| SSM 기본 | `AmazonSSMManagedInstanceCore`, `AmazonEC2RoleforSSM` |
| ECR 추가 | `AmazonEC2ContainerRegistryReadOnly`, `AmazonElasticContainerRegistryPublicFullAccess` |

### SSM 에이전트 확인

[[aws-systemsmanager]]

```shell
sudo snap services amazon-ssm-agent
```

![[2026-02-04 오전 10.16.37.png]]

---

## GitHub Secrets

### DockerHub + SSM 방식

| 시크릿 | Nginx | FastAPI | 설명 |
|--------|:-----:|:-------:|------|
| `DOCKER_USERNAME` | O | O | Docker Hub ID |
| `DOCKER_PAT` | O | O | Docker Hub 토큰 (Read, Write, Delete) |
| `AWS_ACCESS_KEY_ID` | O | O | IAM 액세스 키 |
| `AWS_SECRET_ACCESS_KEY` | O | O | IAM 시크릿 키 |
| `AWS_REGION` | O | O | AWS 리전 |
| `EC2_INSTANCE_ID` | O | O | SSM 대상 EC2 인스턴스 ID |

### ECR + SSM 방식

| 시크릿 | Nginx | FastAPI | 설명 |
|--------|:-----:|:-------:|------|
| `AWS_ACCESS_KEY_ID` | O | O | IAM 액세스 키 |
| `AWS_SECRET_ACCESS_KEY` | O | O | IAM 시크릿 키 |
| `AWS_REGION` | O | O | AWS 리전 |
| `ECR_REPOSITORY` | O | - | ECR 레포 (Nginx 범용) |
| `ECR_REPOSITORY_PISTA_FASTAPI` | - | O | ECR 레포 (FastAPI 전용) |
| `EC2_INSTANCE_ID` | O | O | SSM 대상 EC2 인스턴스 ID |

> [!Note]
> ECR 방식은 `DOCKER_USERNAME`/`DOCKER_PAT` 불필요 (IAM으로 인증).
> FastAPI는 전용 ECR 레포 시크릿 `ECR_REPOSITORY_PISTA_FASTAPI`를 사용한다.
> 상세: [[cicd-deploy-ssm]]

---

## EC2 보안 그룹

| 방향 | 포트 | 프로토콜 | 소스/대상 | 용도 |
|------|------|----------|----------|------|
| Inbound | 80 | TCP | `0.0.0.0/0` | HTTP (Nginx) |
| Inbound | 8000 | TCP | `0.0.0.0/0` | FastAPI (직접 접근 시) |
| Outbound | All | All | `0.0.0.0/0` | DockerHub/ECR Pull, SSM 통신 |

> [!Note]
> SSM 방식은 SSH 22번 포트가 **불필요**하다 ([[cicd-deploy-ssh]] 대비 장점).
> SSM Agent는 아웃바운드 HTTPS(443)로 AWS 서비스에 연결한다.
> 상세: [[cicd-deploy-ssm]]

---

## 2. DockerHub + SSM 배포

### 파이프라인

```
GitHub Actions → DockerHub Push → SSM → EC2에서 docker pull + run
```

### CI 워크플로우

- [[gha-examplel-nginx-dockerhub]] - Nginx
- [[gha-example-fastapi-dockerhub]] - FastAPI

### CICD 결과

![[2026-02-04 오후 5.19.07.png]]

---

## 3. ECR + SSM 배포

### 파이프라인

```
GitHub Actions → ECR Push → SSM → EC2에서 ECR pull + run
```

### IAM 역할 (pista-ecr-role)

[[aws-iam]]

#### 신뢰할 수 있는 엔터티

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": ["sts:AssumeRole"],
            "Principal": {
                "Service": ["ec2.amazonaws.com"]
            }
        }
    ]
}
```

#### 권한 정책

```
AmazonSSMManagedInstanceCore
AmazonEC2RoleforSSM
AmazonEC2ContainerRegistryReadOnly
AmazonElasticContainerRegistryPublicFullAccess
```

### CI 워크플로우

- [[gha-example-nginx-ecr-ssm]] - Nginx
- [[gha-example-fastapi-ecr-ssm]] - FastAPI

### CICD 결과

![[2026-02-04 오후 4.56.15.png]]

---

## 4. AWS 리소스 정리

[[aws-resource-2026-02-04-1]]

---

## 관련 노트

- [[CICD_2026-02-03]] - 이전: SSH 배포
- [[CICD_2026-02-05]] - 다음: S3 + ASG 배포
- [[aws-ec2]] - EC2 인스턴스
- [[aws-iam]] - IAM 역할
- [[aws-systemsmanager]] - AWS Systems Manager
