# CI/CD 파이프라인 구축

#cicd #python #git #docker #aws #ec2 #github

---

```table-of-contents
```

Python FastAPI → GitHub Actions → Docker → EC2 배포

---

## 1. 프로젝트

- [cicd-test](https://github.com/SteelCrab/cicd-test)
- [[gha-example-fastapi-dockerhub]] - 최종 워크플로우

---

## 2. 로컬 개발 환경

### 가상환경

```shell
python3 -m venv .venv
source .venv/bin/activate
```

### requirements.txt

```
fastapi==0.109.0
uvicorn==0.27.0
pytest==8.0.0
httpx==0.26.0
```

### main.py

```python
import uvicorn
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello World"}

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### main_test.py

```python
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_read_main():
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Hello World"}
```

[FastAPI 테스트 문서](https://fastapi.tiangolo.com/tutorial/testing/#fastapi-app-file)

### 실행

```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```

### 테스트

```bash
curl http://localhost:8000/
# {"message": "Hello World"}
```

---

## 3. Git 설정

[[git-init]] → [[git-remote]] → [[git-push]] → [[git-clone]]

---

## 4. GitHub Actions

### 워크플로우

[python-app.yml](https://github.com/SteelCrab/cicd-test/blob/main/.github/workflows/python-app.yml)

### GitHub Secrets (`fastapi-dockerhub.yml`)

> [!Note]
> Repository > Settings > Secrets and variables > Actions > New repository secret

| 시크릿 | 설명 | 비고 |
|--------|------|------|
| `DOCKER_USERNAME` | Docker Hub ID | DockerHub 로그인 |
| `DOCKER_PAT` | Docker Hub 토큰 (Read, Write, Delete) | DockerHub Push |
| `AWS_ACCESS_KEY_ID` | IAM 액세스 키 | SSM 배포용 |
| `AWS_SECRET_ACCESS_KEY` | IAM 시크릿 키 | SSM 배포용 |
| `AWS_REGION` | AWS 리전 | `ap-southeast-1` |
| `EC2_INSTANCE_ID` | EC2 인스턴스 ID | SSM Send-Command 대상 |

> [!Important]
> 초기에는 `SSH_KEY` + `EC2_HOST` + `EC2_USERNAME`으로 SSH 직접 배포.
> 이후 SSM 방식으로 전환하면서 `EC2_INSTANCE_ID`로 변경됨.
> 상세: [[cicd-deploy-ssh]]

### 결과

![[2026-02-03 오후 12.00.17.png]]

[Actions 실행 결과](https://github.com/SteelCrab/cicd-test/actions/runs/21614937290)

---

## 5. Docker

### 이미지 빌드

```shell
docker build -t <DOCKER_ID>/fastapi .
```

[[docker-images]]

### Docker 로그인

```shell
docker login -u <DOCKER_ID>
```

[[docker-pat]]

![[2026-02-03 오후 2.55.23.png]]

---

## 6. EC2 생성 및 설정

### EC2 생성 참고

[[aws-ec2]]

### Security Group

![[2026-02-03 오후 1.57.51.png]]

### 결과

![[2026-02-03 오후 1.55.30 1.png]]

---

## 7. 트러블슈팅

### 테스트 누락

![[2026-02-03 오전 11.53.19.png]]

**해결**: main_test.py 추가

### Docker Push 실패

![[2026-02-03 오후 3.27.06.png]]

| 원인 | 해결 |
|------|------|
| Docker PAT 권한 부족 | PAT 권한 = Read, Write, Delete |

### EC2 배포 실패

![[2026-02-03 오후 3.25.48.png]]

| 원인 | 해결 |
|------|------|
| 환경변수 이름 오타 | EC2_NAME → EC2_USERNAME |

### 최종 성공

![[2026-02-03 오후 3.55.13.png]]

---

## 관련 노트

- [[CICD_2026-02-04]] - 다음: DockerHub/ECR + SSM 배포
- [[gha-example-fastapi-dockerhub]] - 최종 워크플로우
- [[aws-ec2]] - EC2 인스턴스
