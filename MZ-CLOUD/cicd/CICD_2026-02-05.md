# S3 배포 + ASG 연동

#cicd #s3 #asg #ecr #ssm #aws #alb

---

```table-of-contents
```

GitHub Actions → ECR Push → SSM → ASG 인스턴스 배포

---

## 1. S3 배포 (ECR + SSM)

### CI 워크플로우

![[gha-gha-example-s3-ecr-ssm#워크플로우]]

### GitHub 환경 변수

| 변수 | 설명 | 예시 |
|------|------|------|
| `AWS_REGION` | AWS 리전 코드 | `ap-southeast-1` |
| `AWS_ACCESS_KEY_ID` | IAM 액세스 키 | `AKIA************3MK` |
| `AWS_SECRET_ACCESS_KEY` | IAM 시크릿 키 | `rRp7************HDpf` |
| `ECR_REPOSITORY_WEB` | ECR 레포지토리 이름 | `pista/web` |
| `EC2_INSTANCE_ID` | EC2 고유 ID | `i-067bea1ca65311d65` |
| `S3_BUCKET_NAME` | S3 버킷 이름 | `pistachio-s3` |

### IAM 역할 (pista-ec2-ssm-role)

[[aws-iam]]

#### 신뢰할 수 있는 엔터티

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": ["sts:AssumeRole"],
            "Principal": {
                "Service": ["ec2.amazonaws.com"]
            }
        }
    ]
}
```

#### 권한 정책

```
AmazonSSMManagedInstanceCore
AmazonEC2RoleforSSM
AmazonS3ReadOnlyAccess
AmazonEC2ContainerRegistryReadOnly
```

#### 인라인 정책

- ECR-Pull-Policy

### 결과

![[스크린샷 2026-02-05 오전 10.44.36.png]]

---

## 2. EC2 생성 및 사용자 데이터

### EC2 인스턴스 (pista-ec2)

| 항목 | 값 |
|------|-----|
| 이름 | pista-ec2 · i-03ec0ad0483f00aee |
| 상태 | running |
| AMI | ami-08d59269edddde222 |
| 인스턴스 유형 | t3.micro |
| 플랫폼 | Linux |
| 아키텍처 | x86_64 |
| 키 페어 | pista-key |
| VPC | crew-vpc |
| 서브넷 | crew-subnet-public1-ap-southeast-1a |
| 가용 영역 | ap-southeast-1a |
| 프라이빗 IP | 10.0.4.143 |
| 퍼블릭 IP | 13.212.235.81 |
| 보안 그룹 | ec2 |
| IAM 역할 | pista-ec2-ssm-role |

#### 스토리지

| 디바이스 | 볼륨 ID | 크기 | 유형 | 종료 시 삭제 |
|----------|---------|------|------|------------|
| /dev/sda1 | vol-0075c07b0e62dd836 | 0 GB | gp3 | O |

#### 사용자 데이터

```bash
#!/bin/bash

# 1. SSM 에이전트 설치 (최우선 실행)
snap install amazon-ssm-agent --classic
systemctl enable amazon-ssm-agent
systemctl start amazon-ssm-agent

# 2. 패키지 업데이트 및 필수 도구 설치
apt-get update -y
apt-get install -y curl unzip net-tools apt-transport-https ca-certificates gnupg lsb-release

# 3. Docker 설치 (공식 저장소 등록 방식)
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

apt-get update -y
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Docker 권한 설정 및 실행
systemctl enable --now docker
usermod -aG docker ubuntu

# 4. AWS CLI v2 설치
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
./aws/install
rm -rf awscliv2.zip aws/
```

[[aws-asg]]

![[스크린샷 2026-02-05 오전 11.04.12.png]]

---

## 3. AMI 생성 및 Launch Template

### Launch Template (pista-temp-ssm)

| 항목 | 값 |
|------|-----|
| 이름 | pista-temp-ssm |
| ID | `lt-0ecbd62071876764f` |
| 기본 버전 | 1 |
| 최신 버전 | 1 |

#### 인스턴스 설정

| 항목 | 값 |
|------|-----|
| AMI | pista-ssm-ami (`ami-09ad725c1eee19f52`) |
| 인스턴스 타입 | `t3.micro` |
| 키 페어 | pista-key |
| IAM 역할 | pista-ec2-ssm-role |

#### 보안 그룹

| 이름 | ID |
|------|-----|
| ec2 | `sg-07a1c253f1a6c3a00` |

##### EC2 보안 그룹 규칙

| 방향 | 포트 | 프로토콜 | 소스/대상 | 용도 |
|------|------|----------|----------|------|
| Inbound | 80 | TCP | ALB SG | HTTP (ALB에서 전달) |
| Outbound | All | All | `0.0.0.0/0` | ECR Pull, SSM 통신 |

##### ALB 보안 그룹 규칙

| 방향 | 포트 | 프로토콜 | 소스/대상 | 용도 |
|------|------|----------|----------|------|
| Inbound | 80 | TCP | `0.0.0.0/0` | HTTP 트래픽 |
| Inbound | 443 | TCP | `0.0.0.0/0` | HTTPS 트래픽 |
| Outbound | 80 | TCP | EC2 SG | 대상 그룹으로 전달 |

> [!Note]
> ASG 환경에서는 ALB → EC2 트래픽을 **보안 그룹 간 참조**로 제한하는 것이 안전하다.
> SSM 방식이므로 SSH 22번 포트 불필요. 상세: [[cicd-deploy-asg]]

#### 태그

| 키 | 값 |
|-----|-----|
| depolygroup | container-asg |

---

## 4. ASG + ALB 구성

### ASG 생성

> [!NOTE]
> 반드시 태그를 생성하고 GitHub 환경 변수로 저장
> Key: `Name`, Value: `pista-asg`

### ALB 생성

### Systems Manager 확인

> AWS > Systems Manager > 플릿 관리자

> [!NOTE]
> 플릿 관리자에서 모든 SSM 에이전트가 활성화되는지 확인
> ```
> sudo systemctl status snap.amazon-ssm-agent-.amazon-ssm-agent.service
> ```

![[스크린샷 2026-02-05 오후 1.47.26.png]]

---

## 5. GitHub 구성

### 프로젝트 구조

> [!Note]
> origin: https://github.com/SteelCrab/cicd-test.git

```
├── .github
│   └── workflows
│       ├── fastapi-dockerhub.yml
│       ├── fastapi-ecr.yml
│       ├── nginx-asg-s3.yaml
│       ├── nginx-dockerhub.yml
│       ├── nginx-ecr.yaml
│       └── nginx-s3.yaml
├── ec2-user-data
│   ├── user-data-amazon.sh
│   └── user-data-ubuntu.sh
├── nginx
│   └── html
│       ├── images/
│       ├── Dockerfile
│       ├── default.conf
│       ├── index.html
│       └── nginx.conf
├── .gitignore
├── LICENSE
└── README.md
```

### GitHub Secrets

> [!NOTE]
> Repository > Settings > Secrets and variables > Actions > New repository secret

#### S3 배포 (`nginx-s3.yaml`)

| 시크릿 | 설명 | 예시 |
|--------|------|------|
| `AWS_ACCESS_KEY_ID` | IAM 액세스 키 | `AKIA...` |
| `AWS_SECRET_ACCESS_KEY` | IAM 시크릿 키 | |
| `AWS_REGION` | AWS 리전 | `ap-southeast-1` |
| `ECR_REPOSITORY` | ECR 레포 | `pista/web` |
| `EC2_INSTANCE_ID` | SSM 대상 EC2 | `i-067bea...` |
| `S3_BUCKET_NAME` | S3 버킷 이름 | `pistachio-s3` |

#### ASG 배포 (`nginx-asg-s3.yaml`)

| 시크릿 | 설명 | 예시 |
|--------|------|------|
| `AWS_ACCESS_KEY_ID` | IAM 액세스 키 | `AKIA...` |
| `AWS_SECRET_ACCESS_KEY` | IAM 시크릿 키 | |
| `AWS_REGION` | AWS 리전 | `ap-southeast-1` |
| `ECR_REPOSITORY` | ECR 레포 | `pista/web` |
| `ASG_TAG_KEY` | EC2 태그 키 | `Name` |
| `ASG_TAG_VALUE` | EC2 태그 값 | `pista-asg` |

> [!Important]
> S3 배포: `EC2_INSTANCE_ID` + `S3_BUCKET_NAME` (단일 EC2 대상)
> ASG 배포: `ASG_TAG_KEY` + `ASG_TAG_VALUE` (태그 기반 다중 EC2 대상)
> 상세: [[cicd-deploy-asg]]

---

## 6. CICD Pipeline (nginx-s3.yaml)

> [!NOTE]
> - EC2 생성마다 수동으로 CD를 해줘야 함
> - CD 구간에서 빌드를 해도 실패할 수 있음

```yaml
name: Nginx-ASG-Pipeline

on:
  push:
    branches: ["ci/asg"]
    paths:
      - "nginx/**"
  pull_request:
    branches: ["ci/asg"]
    paths:
      - "nginx/**"

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1단계: 리포지토리 코드 가져오기
      - name: Checkout code
        uses: actions/checkout@v4

      # 2단계: AWS 자격 증명 설정
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3단계: ECR 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4단계: Docker 이미지 빌드 및 ECR Push
      - name: Build and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest ./nginx/html
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # 5단계: SSM을 통한 ASG 인스턴스 배포
      - name: Deploy to ASG via SSM
        run: |
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          REPO="${{ secrets.ECR_REPOSITORY }}"
          TAG="${{ github.sha }}"
          FULL_IMAGE="$REGISTRY/$REPO:$TAG"

          COMMAND_ID=$(aws ssm send-command \
            --targets "Key=tag:${{ secrets.ASG_TAG_KEY }},Values=${{ secrets.ASG_TAG_VALUE }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploying Nginx via GitHub Actions" \
            --region ${{ secrets.AWS_REGION }} \
            --parameters "{
              \"commands\": [
                \"aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin $REGISTRY\",
                \"sudo docker pull $FULL_IMAGE\",
                \"sudo docker stop nginx-server || true\",
                \"sudo docker rm nginx-server || true\",
                \"sudo docker run -d --name nginx-server -p 80:80 $FULL_IMAGE\",
                \"sudo docker image prune -f\"
              ]
            }" \
            --query 'Command.CommandId' \
            --output text)

          echo "Waiting for SSM command $COMMAND_ID to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --region ${{ secrets.AWS_REGION }} \
            --max-attempts 30 \
            --delay 10

          echo "Checking command execution status..."
          aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --region ${{ secrets.AWS_REGION }} \
            --details \
            --query 'CommandInvocations[*].[InstanceId,Status,CommandPlugins[0].Output]' \
            --output text
```

---

## 7. 결과

### CI 결과

> [!NOTE]
> SSM 에이전트의 EC2가 전부 활성화되어 있을 때 CD 배포하는 것이 좋다
> ```
> Re-run all jobs
> ```

![[스크린샷 2026-02-05 오후 12.19.11.png]]

### 대상 그룹 및 웹 페이지

![[스크린샷 2026-02-05 오후 1.54.15.png]]
![[스크린샷 2026-02-05 오후 2.45.09.png]]

---

## 관련 노트

- [[CICD_2026-02-04]] - 이전: DockerHub/ECR + SSM 배포
- [[CICD_2026-02-06]] - 다음: EKS 클러스터 구축
- [[aws-asg]] - Auto Scaling Group
- [[aws-iam]] - IAM 역할
- [[aws-resource-2026-02-04-1]] - AWS 리소스 Blueprint
