# =============================================================================
# [Step 5] 애플리케이션 사용자 생성 Job
# 클러스터 생성 후 init.sql 적용
# =============================================================================
#
# 선행조건: Step 4 (innodb-cluster Running 상태)
#
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: mysql-init-schema
  namespace: gition
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mysql-init
        image: mysql:8.0
        env:
        - name: MYSQL_HOST
          value: "mysql-cluster"
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-cluster-secret
              key: rootPassword
        command:
        - bash
        - -c
        - |
          echo "[Init] Waiting for MySQL Cluster to be ready..."
          until mysql -h ${MYSQL_HOST} -uroot -p"${MYSQL_ROOT_PASSWORD}" -e "SELECT 1" 2>/dev/null; do
            echo "[Init] MySQL not ready, waiting..."
            sleep 10
          done
          echo "[Init] MySQL Cluster is ready!"
          
          echo "[Init] Creating database and user..."
          mysql -h ${MYSQL_HOST} -uroot -p"${MYSQL_ROOT_PASSWORD}" <<EOF
          -- Create database
          CREATE DATABASE IF NOT EXISTS gition 
            CHARACTER SET utf8mb4 
            COLLATE utf8mb4_unicode_ci;
          
          -- Create application user
            CREATE USER IF NOT EXISTS 'pista'@'%' 
              IDENTIFIED WITH mysql_native_password BY '${MYSQL_USER_PASSWORD}';
            GRANT ALL PRIVILEGES ON gition.* TO 'pista'@'%';
          FLUSH PRIVILEGES;
          
          -- Switch to gition database
          USE gition;
          
          -- Users table
          CREATE TABLE IF NOT EXISTS users (
              id INT AUTO_INCREMENT PRIMARY KEY,
              github_id BIGINT UNIQUE NOT NULL,
              login VARCHAR(255) NOT NULL,
              name VARCHAR(255),
              email VARCHAR(255),
              avatar_url TEXT,
              access_token TEXT,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
              INDEX idx_github_id (github_id),
              INDEX idx_login (login)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          -- Repositories table
          CREATE TABLE IF NOT EXISTS repositories (
              id INT AUTO_INCREMENT PRIMARY KEY,
              user_id INT NOT NULL,
              github_repo_id BIGINT NOT NULL,
              name VARCHAR(255) NOT NULL,
              full_name VARCHAR(255) NOT NULL,
              description TEXT,
              is_private BOOLEAN DEFAULT FALSE,
              html_url TEXT,
              clone_url TEXT,
              ssh_url TEXT,
              language VARCHAR(100),
              stargazers_count INT DEFAULT 0,
              default_branch VARCHAR(100) DEFAULT 'main',
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
              synced_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
              UNIQUE KEY unique_user_repo (user_id, github_repo_id),
              INDEX idx_user_id (user_id)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          -- Sessions table
          CREATE TABLE IF NOT EXISTS sessions (
              id INT AUTO_INCREMENT PRIMARY KEY,
              user_id INT NOT NULL,     
              token_hash VARCHAR(255) NOT NULL,
              expires_at TIMESTAMP NOT NULL,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
              INDEX idx_token_hash (token_hash),
              INDEX idx_user_id (user_id)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          -- Documents table
          CREATE TABLE IF NOT EXISTS documents (
              id INT AUTO_INCREMENT PRIMARY KEY,
              user_id INT NOT NULL,
              repo_id INT,
              title VARCHAR(500) NOT NULL DEFAULT 'Untitled',
              content JSON,
              is_public BOOLEAN DEFAULT FALSE,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
              FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
              FOREIGN KEY (repo_id) REFERENCES repositories(id) ON DELETE SET NULL,
              INDEX idx_user_id (user_id),
              INDEX idx_repo_id (repo_id)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          -- Pipelines table
          CREATE TABLE IF NOT EXISTS pipelines (
              id INT AUTO_INCREMENT PRIMARY KEY,
              user_id INT NOT NULL,
              repo_id INT,
              name VARCHAR(255) NOT NULL,
              config JSON,
              status ENUM('idle', 'running', 'success', 'failed') DEFAULT 'idle',
              last_run_at TIMESTAMP,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
              FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
              FOREIGN KEY (repo_id) REFERENCES repositories(id) ON DELETE SET NULL,
              INDEX idx_user_id (user_id),
              INDEX idx_repo_id (repo_id)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          -- Branch Pages table
          CREATE TABLE IF NOT EXISTS branch_pages (
              id CHAR(36) PRIMARY KEY,
              user_id INT NOT NULL,
              repo_id INT NOT NULL,
              branch_name VARCHAR(255) NOT NULL,
              title VARCHAR(500) DEFAULT '',
              content LONGTEXT,
              metadata JSON,
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
              FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
              FOREIGN KEY (repo_id) REFERENCES repositories(id) ON DELETE CASCADE,
              UNIQUE KEY unique_user_repo_branch (user_id, repo_id, branch_name),
              INDEX idx_user_id (user_id),
              INDEX idx_repo_id (repo_id),
              INDEX idx_branch_name (branch_name)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          EOF
          
          echo "[Init] Schema initialization completed!"
