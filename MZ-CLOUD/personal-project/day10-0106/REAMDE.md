# Day 10 - MySQL Read/Write ë¶„ë¦¬ ì‹œë„ ë° ì„ì‹œ ì¡°ì¹˜ (01/06)

> Slave DB ì—°ê²° ì™„ë£Œ, ë³µì œ ì§€ì—° ë¬¸ì œë¡œ ì„ì‹œë¡œ Master ì‚¬ìš©

## ğŸ“‹ ëª©ì°¨

1. [ğŸ“‹ ê°œìš”](#-ê°œìš”)
2. [ğŸ”§ í•´ê²°í•œ ë¬¸ì œë“¤](#-í•´ê²°í•œ-ë¬¸ì œë“¤)
3. [âš ï¸ ë°œìƒí•œ ë¬¸ì œ](#-ë°œìƒí•œ-ë¬¸ì œ)
4. [âš™ï¸ ìµœì¢… ì„¤ì •](#-ìµœì¢…-ì„¤ì •)
5. [ğŸ“ ë‹¤ìŒ ë‹¨ê³„](#-ë‹¤ìŒ-ë‹¨ê³„)

---

## ğŸ“‹ ê°œìš”

### ë°°ê²½

Day 9ì—ì„œ DNS ë¬¸ì œë¡œ ëª¨ë“  DB ì—°ê²°ì„ Master IPë¡œ ì§ì ‘ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.
ì˜¤ëŠ˜ì€ K8s ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ì •ìƒì ìœ¼ë¡œ DBì— ì—°ê²°í•˜ë„ë¡ ë³µêµ¬í–ˆìŠµë‹ˆë‹¤.

### ì˜¤ëŠ˜ ì‘ì—… ë‚´ìš©

| ì‘ì—… | ìƒíƒœ |
|------|------|
| mysql-read ì„œë¹„ìŠ¤ Headless â†’ ClusterIP | âœ… |
| mysql-master ì„œë¹„ìŠ¤ ExternalName â†’ ClusterIP+Endpoints | âœ… |
| pista ì‚¬ìš©ì mysql_native_password ì¸ì¦ | âœ… |
| Master â†’ Slave ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ìë™í™” | âœ… |
| Read/Write ë¶„ë¦¬ í…ŒìŠ¤íŠ¸ | âš ï¸ ë³µì œ ì§€ì—° ë¬¸ì œ |
| **ì„ì‹œ ì¡°ì¹˜: Readë„ Master ì‚¬ìš©** | âœ… |

---

## ğŸ”§ í•´ê²°í•œ ë¬¸ì œë“¤

### 1. ì„œë¹„ìŠ¤ íƒ€ì… ë³€ê²½

| ì„œë¹„ìŠ¤ | ë³€ê²½ ì „ | ë³€ê²½ í›„ |
|--------|--------|--------|
| `mysql-master` | ExternalName | ClusterIP + Endpoints |
| `mysql-read` | Headless | ClusterIP |

```bash
kubectl delete svc mysql-master mysql-read -n gition
kubectl apply -f mysql-master-svc.yaml
kubectl apply -f mysql-slave.yaml
```

### 2. MySQL ì¸ì¦ ë°©ì‹

Slaveì˜ pista ì‚¬ìš©ì â†’ `mysql_native_password`ë¡œ ë³€ê²½ (ìë™í™” ì ìš©)

### 3. ì´ˆê¸° ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”

GTID ë³µì œëŠ” ì—°ê²° í›„ ë³€ê²½ë§Œ ë™ê¸°í™” â†’ mysqldumpë¡œ ì´ˆê¸° ìŠ¤í‚¤ë§ˆ ë³µì‚¬ (ìë™í™” ì ìš©)

---

## âš ï¸ ë°œìƒí•œ ë¬¸ì œ

### ë³µì œ ì§€ì—°ìœ¼ë¡œ ì¸í•œ Duplicate Key ì—ëŸ¬

```
IntegrityError: Duplicate entry for key 'branch_pages.unique_user_repo_branch'
```

**ì›ì¸:**
1. Masterì— ë°ì´í„° ìƒì„± (Write)
2. ì¦‰ì‹œ Slaveì—ì„œ ì½ê¸° ì‹œë„ (Read)
3. ì•„ì§ ë³µì œ ì•ˆ ë¨ â†’ ì—†ë‹¤ê³  íŒë‹¨ â†’ ë‹¤ì‹œ ìƒì„± ì‹œë„ â†’ ì¤‘ë³µ ì—ëŸ¬

**ì„ì‹œ ì¡°ì¹˜:** Readë„ Masterë¡œ ì „í™˜

---

## âš™ï¸ ìµœì¢… ì„¤ì •

### fastapi-deployment.yaml

```yaml
- name: MYSQL_READ_HOST
  value: "mysql-master"   # ì„ì‹œ: ë³µì œ ì§€ì—° ë¬¸ì œë¡œ Master ì‚¬ìš©
- name: MYSQL_WRITE_HOST
  value: "mysql-master"
```

### í˜„ì¬ ì•„í‚¤í…ì²˜

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  FastAPI    â”‚
                â”‚  Backend    â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                       â”‚
     READ (SELECT)           WRITE (INSERT/UPDATE)
           â”‚                       â”‚
           â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚mysql-master â”‚         â”‚mysql-master â”‚  â† ë‘˜ ë‹¤ Masterë¡œ ì—°ê²°
    â”‚ ClusterIP   â”‚         â”‚ ClusterIP   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚                       â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Master    â”‚
                â”‚172.100.100.11â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Replication (ìœ ì§€)
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  slave-0    â”‚         â”‚  slave-1    â”‚  â† ëŒ€ê¸° (í–¥í›„ ì‚¬ìš©)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„

### ì½”ë“œ ìˆ˜ì • í•„ìš” (í–¥í›„)

1. **`await` ëˆ„ë½ ìˆ˜ì •**
   ```
   RuntimeWarning: coroutine 'ensure_branch_page_by_login' was never awaited
   ```

2. **Read-Your-Own-Writes íŒ¨í„´ ì ìš©**
   - ìƒì„±/ìˆ˜ì • ì§í›„ ì½ê¸°ëŠ” `use_write_pool=True` ì‚¬ìš©

3. **Readë¥¼ Slaveë¡œ ë³µì›**
   ```yaml
   - name: MYSQL_READ_HOST
     value: "mysql-read"   # ì½”ë“œ ìˆ˜ì • í›„ ë³µì›
   ```

---

## ğŸ“š ì°¸ê³ 

- [Day 9 - K8s ë°°í¬ ë° Ingress êµ¬ì¡° ê°œì„ ](./README%20copy.md)
- [k8s/mysql-slave.yaml](../pista-megazoncloud/personal-project/day2-1229/k8s/mysql-slave.yaml)
- [k8s/fastapi-deployment.yaml](../pista-megazoncloud/personal-project/day2-1229/k8s/fastapi-deployment.yaml)
