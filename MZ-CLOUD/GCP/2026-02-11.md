# GCP 정적 웹사이트(GCS+LB) & LB+인스턴스그룹 구성

#gcp #cloud #gcs #loadbalancer #인스턴스그룹 #템플릿

---

## 1. GCS 정적 웹사이트 + Load Balancer

> AWS S3 정적 웹 호스팅과 동일한 패턴을 GCP에서 구현

```
사용자 → http://<LB_IP>
  └── Forwarding Rule (port:80)
      └── HTTP Proxy → URL Map → Backend Bucket (CDN)
          └── GCS Bucket (index.html, 404.html)
```

### 플레이스홀더

| 변수 | 설명 | 예시 |
|------|------|------|
| `BUCKET_NAME` | GCS 버킷 이름 | `pista-static-site` |
| `BACKEND_BUCKET` | 백엔드 버킷 이름 | `pista-static-backend` |
| `URL_MAP` | URL 맵 이름 | `pista-static-url-map` |
| `HTTP_PROXY` | HTTP 프록시 이름 | `pista-static-http-proxy` |
| `LB_IP` | 전역 IP 이름 | `pista-static-lb-ip` |
| `FORWARDING_RULE` | 포워딩 룰 이름 | `pista-static-http-rule` |
| `REGION` | 리전 | `asia-northeast1` |

### 구현 프로세스

**1단계: 버킷 생성**

```bash
gcloud storage buckets create gs://$BUCKET_NAME \
    --location=$REGION \
    --uniform-bucket-level-access
```

**2단계: 공개 설정**

```bash
gcloud storage buckets add-iam-policy-binding gs://$BUCKET_NAME \
    --member=allUsers \
    --role=roles/storage.objectViewer
```

**3단계: 정적 사이트 업로드 + 웹사이트 설정**

```bash
gcloud storage cp index.html gs://$BUCKET_NAME/
gcloud storage cp 404.html gs://$BUCKET_NAME/

gcloud storage buckets update gs://$BUCKET_NAME \
    --web-main-page-suffix=index.html \
    --web-error-page=404.html
```

**4단계: 백엔드 버킷 (CDN 포함)**

```bash
gcloud compute backend-buckets create $BACKEND_BUCKET \
    --gcs-bucket-name=$BUCKET_NAME \
    --enable-cdn
```

**5단계: URL Map → HTTP Proxy**

```bash
gcloud compute url-maps create $URL_MAP \
    --default-backend-bucket=$BACKEND_BUCKET

gcloud compute target-http-proxies create $HTTP_PROXY \
    --url-map=$URL_MAP
```

**6단계: 전역 IP + Forwarding Rule**

```bash
gcloud compute addresses create $LB_IP --ip-version=IPV4 --global

gcloud compute forwarding-rules create $FORWARDING_RULE \
    --address=$LB_IP \
    --target-http-proxy=$HTTP_PROXY \
    --ports=80 --global
```

**확인**

```bash
LB_ADDR=$(gcloud compute addresses describe $LB_IP --global --format="value(address)")
curl http://$LB_ADDR
```

---

## 2. HTTP(S) LB + MIG + 인스턴스 템플릿

> AWS Launch Template → ASG → ALB 패턴과 동일

### AWS vs GCP 비교

| AWS | GCP |
|-----|-----|
| Launch Template | Instance Template |
| Auto Scaling Group | Managed Instance Group (MIG) |
| ALB | HTTP(S) Load Balancer |
| Target Group | Backend Service |

### 아키텍처

```
사용자 → http://<LB_IP>
  └── Forwarding Rule (port:80)
      └── HTTP Proxy → URL Map → Backend Service
          ├── Health Check (HTTP:80, path:/)
          └── MIG (min:2 / max:5 / CPU 75%)
              └── Instance Template (e2-micro, Nginx)
```

### 플레이스홀더

| 변수 | 설명 | 예시 |
|------|------|------|
| `PROJECT_ID` | 프로젝트 ID | `gcloud config get-value project` |
| `REGION` | 리전 | `asia-northeast1` |
| `PUBLIC_SUBNET` | 퍼블릭 서브넷 | `pista-public-subnet` |
| `TEMPLATE_NAME` | 인스턴스 템플릿 | `pista-web-template` |
| `MIG_NAME` | 인스턴스 그룹 | `pista-web-mig` |
| `HEALTH_CHECK` | 헬스 체크 | `pista-health-check` |
| `BACKEND_SERVICE` | 백엔드 서비스 | `pista-backend-service` |
| `URL_MAP` | URL 맵 | `pista-url-map` |
| `HTTP_PROXY` | HTTP 프록시 | `pista-http-proxy` |
| `LB_IP` | 전역 고정 IP | `pista-lb-ip` |
| `FORWARDING_RULE` | 포워딩 룰 | `pista-http-rule` |

### 구현 프로세스

**1단계: 인스턴스 템플릿**

```bash
gcloud compute instance-templates create $TEMPLATE_NAME \
    --machine-type=e2-micro \
    --subnet=projects/$PROJECT_ID/regions/$REGION/subnetworks/$PUBLIC_SUBNET \
    --region=$REGION \
    --image-family=ubuntu-2204-lts \
    --image-project=ubuntu-os-cloud \
    --boot-disk-size=10GB \
    --tags=http-server \
    --metadata=startup-script='#!/bin/bash
apt-get update && apt-get install -y nginx
INSTANCE_NAME=$(curl -s -H "Metadata-Flavor: Google" \
    http://metadata.google.internal/computeMetadata/v1/instance/name)
cat > /var/www/html/index.html <<HTML
<h1>$INSTANCE_NAME</h1>
HTML
systemctl restart nginx'
```

**2단계: 헬스 체크**

```bash
gcloud compute health-checks create http $HEALTH_CHECK \
    --port=80 --request-path=/
```

**3단계: MIG + 자동 확장 + 자동 복구**

```bash
# MIG 생성 (리전 MIG = 멀티 존 분산)
gcloud compute instance-groups managed create $MIG_NAME \
    --base-instance-name=web \
    --template=$TEMPLATE_NAME \
    --size=2 \
    --region=$REGION \
    --target-distribution-shape=EVEN

# Named Port (LB 백엔드에서 참조)
gcloud compute instance-groups managed set-named-ports $MIG_NAME \
    --named-ports=http:80 --region=$REGION

# 자동 확장
gcloud compute instance-groups managed set-autoscaling $MIG_NAME \
    --region=$REGION \
    --min-num-replicas=2 \
    --max-num-replicas=5 \
    --target-cpu-utilization=0.75

# 자동 복구 (헬스 체크 실패 시 인스턴스 재생성)
gcloud compute instance-groups managed update $MIG_NAME \
    --region=$REGION \
    --health-check=$HEALTH_CHECK \
    --initial-delay=120
```

**4단계: 백엔드 서비스**

```bash
gcloud compute backend-services create $BACKEND_SERVICE \
    --protocol=HTTP \
    --port-name=http \
    --health-checks=$HEALTH_CHECK \
    --global

gcloud compute backend-services add-backend $BACKEND_SERVICE \
    --instance-group=$MIG_NAME \
    --instance-group-region=$REGION \
    --balancing-mode=UTILIZATION \
    --max-utilization=0.8 \
    --global
```

**5단계: URL Map → HTTP Proxy**

```bash
gcloud compute url-maps create $URL_MAP \
    --default-service=$BACKEND_SERVICE

gcloud compute target-http-proxies create $HTTP_PROXY \
    --url-map=$URL_MAP
```

**6단계: 전역 IP + Forwarding Rule**

```bash
gcloud compute addresses create $LB_IP --ip-version=IPV4 --global

gcloud compute forwarding-rules create $FORWARDING_RULE \
    --address=$LB_IP \
    --target-http-proxy=$HTTP_PROXY \
    --ports=80 --global
```

**확인**

```bash
LB_ADDR=$(gcloud compute addresses describe $LB_IP --global --format="value(address)")
curl http://$LB_ADDR
```

---

## 3. 구축 스크립트

| 스크립트 | 용도 | 실행 |
|---------|------|------|
| `gcp-gcs-setup.sh` | GCS + LB 정적 사이트 구축 | `bash gcp-gcs-setup.sh` |
| `gcp-gcs-cleanup.sh` | GCS + LB 리소스 정리 | `bash gcp-gcs-cleanup.sh` |
| `gcp-lb-setup.sh` | LB + MIG + 템플릿 구축 | `bash gcp-lb-setup.sh` |
| `gcp-simple-setup.sh` | 심플 VM 2대 (Public + Private) | `bash gcp-simple-setup.sh` |
| `gcp-simple-cleanup.sh` | 심플 VM 리소스 정리 | `bash gcp-simple-cleanup.sh` |

---

## 관련 노트

- [GCP_MOC](./GCP_MOC.md)
