# GCP 정적 웹사이트(GCS+LB) & LB+인스턴스그룹 구성

#gcp #cloud #gcs #loadbalancer #인스턴스그룹 #템플릿

---

```table-of-contents
```

## 1. GCS 정적 웹사이트 + Load Balancer (AWS S3 대응)

### 개요

AWS S3 정적 웹 호스팅과 동일한 패턴을 GCP에서 구현한다.
Cloud Storage 버킷에 정적 파일(HTML/CSS/JS)을 올리고, HTTP(S) Load Balancer를 앞에 두어 서비스한다.

### AWS S3 vs GCP GCS 비교

| **항목** | **AWS** | **GCP** |
|---------|---------|---------|
| **저장소** | S3 Bucket | Cloud Storage Bucket |
| **정적 호스팅** | S3 Static Website Hosting | GCS + URL 설정 (MainPage/ErrorPage) |
| **CDN** | CloudFront | Cloud CDN (백엔드 버킷에서 활성화) |
| **로드밸런서** | ALB / CloudFront | HTTP(S) Load Balancer |
| **SSL** | ACM 인증서 | Google Managed Certificate |
| **직접 접속** | `http://<bucket>.s3-website.<region>.amazonaws.com` | `https://storage.googleapis.com/<bucket>/index.html` |

### 아키텍처

```
사용자 → http://<전역 IP>
│
HTTP(S) Load Balancer (Global)
├── Forwarding Rule (pista-static-http-rule, port:80)
│   └── 전역 IP (pista-static-lb-ip)
│
├── Target HTTP Proxy (pista-static-http-proxy)
│   └── URL Map (pista-static-url-map)
│       └── default → Backend Bucket
│
└── Backend Bucket (pista-static-backend)
    ├── Cloud CDN: 활성화 (Google 엣지 캐시)
    └── Cloud Storage Bucket (pista-static-site)
        ├── index.html (MainPage)
        ├── 404.html (ErrorPage)
        └── 공개 접근: allUsers → objectViewer
```

### 구축 흐름 (7단계)

| **단계** | **리소스** | **설명** |
|---------|-----------|---------|
| 1 | Cloud Storage 버킷 | 정적 파일 저장소 생성 |
| 2 | 버킷 공개 설정 | `allUsers`에게 `objectViewer` 권한 부여 |
| 3 | 정적 사이트 업로드 | index.html, 404.html 업로드 + 웹사이트 설정 |
| 4 | 백엔드 버킷 | GCS를 LB 백엔드로 연결 + CDN 활성화 |
| 5 | URL Map | 요청 경로 → 백엔드 매핑 |
| 6 | HTTP Proxy | URL Map을 프록시로 연결 |
| 7 | 전역 IP + Forwarding Rule | 외부 IP 할당 + 포트 80 포워딩 |

### 핵심 명령어

```bash
# 버킷 생성
gcloud storage buckets create gs://pista-static-site \
    --location=asia-northeast1 \
    --uniform-bucket-level-access

# 공개 설정
gcloud storage buckets add-iam-policy-binding gs://pista-static-site \
    --member=allUsers \
    --role=roles/storage.objectViewer

# 웹사이트 설정
gcloud storage buckets update gs://pista-static-site \
    --web-main-page-suffix=index.html \
    --web-error-page=404.html

# 백엔드 버킷 (CDN 포함)
gcloud compute backend-buckets create pista-static-backend \
    --gcs-bucket-name=pista-static-site \
    --enable-cdn

# URL Map → HTTP Proxy → Forwarding Rule
gcloud compute url-maps create pista-static-url-map \
    --default-backend-bucket=pista-static-backend

gcloud compute target-http-proxies create pista-static-http-proxy \
    --url-map=pista-static-url-map

gcloud compute addresses create pista-static-lb-ip --ip-version=IPV4 --global

gcloud compute forwarding-rules create pista-static-http-rule \
    --address=pista-static-lb-ip \
    --target-http-proxy=pista-static-http-proxy \
    --ports=80 --global
```

### 포인트

- **백엔드 버킷** = GCS를 LB의 백엔드로 직접 연결 (VM 없이 정적 콘텐츠 서빙)
- **Cloud CDN** = `--enable-cdn` 한 줄로 활성화, Google 엣지 캐시 사용
- **전역 LB** = Anycast IP로 전 세계 단일 진입점 제공

---

## 2. HTTP(S) LB + 인스턴스 그룹 + 템플릿 구성

### 개요

2개 서브넷(Public/Private) 위에 인스턴스 템플릿 → MIG(관리형 인스턴스 그룹) → HTTP(S) LB를 구성한다.
AWS의 Launch Template → Auto Scaling Group → ALB 패턴과 동일하다.

### AWS vs GCP 비교

| **항목** | **AWS** | **GCP** |
|---------|---------|---------|
| **템플릿** | Launch Template | Instance Template |
| **오토스케일링** | Auto Scaling Group (ASG) | Managed Instance Group (MIG) |
| **로드밸런서** | ALB (Application Load Balancer) | HTTP(S) Load Balancer |
| **헬스 체크** | Target Group Health Check | Compute Health Check |
| **백엔드 연결** | Target Group → ASG | Backend Service → MIG |

### 아키텍처

```
사용자 → http://<전역 IP>
│
HTTP(S) Load Balancer (Global)
├── Forwarding Rule (pista-http-rule, port:80)
│   └── 전역 IP (pista-lb-ip)
│
├── Target HTTP Proxy (pista-http-proxy)
│   └── URL Map (pista-url-map)
│       └── default → Backend Service
│
└── Backend Service (pista-backend-service)
    ├── 분산 정책: UTILIZATION (max 80%)
    ├── Health Check (pista-health-check, HTTP:80, path:/)
    └── MIG (pista-web-mig, 리전: asia-northeast1)
        ├── 자동 확장: min:2 / max:5 / CPU 75%
        ├── 자동 복구: Health Check 실패 시 재생성
        ├── Named Port: http:80
        └── Instance Template (pista-web-template)
            ├── Machine: e2-micro
            ├── Image: ubuntu-2204-lts
            ├── Tags: http-server
            ├── Startup: Nginx 설치 + 메타데이터 기반 HTML
            │
            ├── web-xxxx (zone-a) ← 자동 생성
            └── web-yyyy (zone-b) ← 자동 생성

─── 네트워크 ─────────────────────────
pista-vpc (Custom Mode)
├── pista-public-subnet  (10.0.1.0/24)
│   └── MIG 인스턴스 배치 (External IP 있음)
│
├── pista-private-subnet (10.0.2.0/24)
│   └── Private VM (External IP 없음)
│
├── Cloud Router (pista-router)
│   └── Cloud NAT (pista-nat) → Private 아웃바운드 인터넷
│
└── 방화벽 규칙
    ├── allow-ssh-pista-vpc       : tcp:22 (0.0.0.0/0)
    ├── allow-http-pista-vpc      : tcp:80,443 → tag:http-server
    ├── allow-internal-pista-vpc  : all (10.0.0.0/8)
    └── allow-health-check-pista-vpc : tcp:80 (Google HC 대역)
```

### 구축 흐름 (7단계)

| **단계** | **리소스** | **설명** |
|---------|-----------|---------|
| 1 | 인스턴스 템플릿 | VM 스펙 정의 (e2-micro, Nginx startup-script) |
| 2 | 헬스 체크 | HTTP 80번 포트, `/` 경로로 상태 확인 |
| 3 | MIG | 템플릿 기반 인스턴스 2개 생성 + 자동 확장 (2~5대, CPU 75%) + 자동 복구 |
| 4 | 백엔드 서비스 | MIG를 백엔드로 등록 + 사용률 기반 분산 |
| 5 | URL Map | 요청 → 백엔드 서비스 매핑 |
| 6 | HTTP Proxy | URL Map 연결 |
| 7 | 전역 IP + Forwarding Rule | 외부 IP + 포트 80 포워딩 |

### 인스턴스 템플릿 핵심

```bash
gcloud compute instance-templates create pista-web-template \
    --machine-type=e2-micro \
    --subnet=projects/$PROJECT_ID/regions/$REGION/subnetworks/$PUBLIC_SUBNET \
    --region=$REGION \
    --image-family=ubuntu-2204-lts \
    --image-project=ubuntu-os-cloud \
    --boot-disk-size=10GB \
    --tags=http-server \
    --metadata=startup-script='#!/bin/bash
apt-get update && apt-get install -y nginx
# 메타데이터 서버에서 인스턴스 정보 조회
INSTANCE_NAME=$(curl -s -H "Metadata-Flavor: Google" \
    http://metadata.google.internal/computeMetadata/v1/instance/name)
# ... HTML 생성
systemctl restart nginx'
```

> [!Note] 메타데이터 서버
> GCP VM은 `http://metadata.google.internal/computeMetadata/v1/` 에서 자기 자신의 정보(인스턴스명, 존, IP 등)를 조회할 수 있다. startup-script에서 이를 활용하여 각 인스턴스가 고유한 페이지를 제공한다.

### MIG (관리형 인스턴스 그룹) 핵심

```bash
# MIG 생성 (리전 MIG = 여러 존에 분산)
gcloud compute instance-groups managed create pista-web-mig \
    --base-instance-name=web \
    --template=pista-web-template \
    --size=2 \
    --region=asia-northeast1 \
    --target-distribution-shape=EVEN

# Named Port 설정 (LB 백엔드에서 참조)
gcloud compute instance-groups managed set-named-ports pista-web-mig \
    --named-ports=http:80 --region=asia-northeast1

# 자동 확장 설정
gcloud compute instance-groups managed set-autoscaling pista-web-mig \
    --region=asia-northeast1 \
    --min-num-replicas=2 \
    --max-num-replicas=5 \
    --target-cpu-utilization=0.75

# 자동 복구 설정 (헬스 체크 연동)
gcloud compute instance-groups managed update pista-web-mig \
    --region=asia-northeast1 \
    --health-check=pista-health-check \
    --initial-delay=120
```

### LB 컴포넌트 관계

```
Forwarding Rule (port 80, 전역 IP)
    └── Target HTTP Proxy
            └── URL Map (라우팅 규칙)
                    └── Backend Service (백엔드 + 분산 정책)
                            ├── Health Check (상태 확인)
                            └── MIG (인스턴스 그룹)
                                    └── Instance Template (VM 템플릿)
```

### 포인트

- **리전 MIG** = 여러 존에 걸쳐 인스턴스를 분산 배치 → 고가용성
- **자동 확장** = CPU 사용률 기반으로 2~5대 자동 조절
- **자동 복구** = 헬스 체크 실패 시 인스턴스 자동 재생성
- **Named Port** = MIG에서 `http:80` 포트 이름을 정의, Backend Service가 이를 참조
- **분산 테스트** = 여러 번 curl 하면 다른 인스턴스로 응답이 분산되는 것을 확인

---

## 3. 구축 스크립트

| **스크립트**                   | **용도**                      | **실행**                          |
| -------------------------- | --------------------------- | ------------------------------- |
| `gcp-04-gcs-setup.sh`      | GCS + LB 정적 사이트 구축          | `bash gcp-04-gcs-setup.sh`      |
| `gcp-04-gcs-cleanup.sh`    | GCS + LB 리소스 정리             | `bash gcp-04-gcs-cleanup.sh`    |
| `gcp-03-lb-setup.sh`       | LB + MIG + 템플릿 구축           | `bash gcp-03-lb-setup.sh`       |
| `gcp-05-simple-setup.sh`   | 심플 VM 2대 (Public + Private) | `bash gcp-05-simple-setup.sh`   |
| `gcp-05-simple-cleanup.sh` | 심플 VM 리소스 정리                | `bash gcp-05-simple-cleanup.sh` |

---

## 관련 노트

- [[GCP]] - GCP 전체 정리 (VPC, Compute Engine, Cloud SQL)
