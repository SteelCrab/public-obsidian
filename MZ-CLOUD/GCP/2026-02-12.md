# GCP ì¸í”„ë¼ êµ¬ì¶• 

#gcp #network #vm #nat

```table-of-contents
```

---

## 1. ë„¤íŠ¸ì›Œí¬ ì¸í”„ë¼ êµ¬ì„± (VPC, NAT, Firewall)

GCPì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì„ êµ¬ì„±í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤. Custom VPCë¥¼ ìƒì„±í•˜ê³ , Public/Private ì„œë¸Œë„·ì„ ë‚˜ëˆˆ ë’¤, Private ì„œë¸Œë„·ì´ ì¸í„°ë„·ì— ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ Cloud NATë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

### ì•„í‚¤í…ì²˜

```
pista-vpc (Custom Mode)
â”œâ”€â”€ pista-public-subnet  (10.0.1.0/24)
â”œâ”€â”€ pista-private-subnet (10.0.2.0/24)
â”œâ”€â”€ pista-router
â”‚   â””â”€â”€ pista-nat (Auto Allocate IP)
â””â”€â”€ Firewall Rules
    â”œâ”€â”€ allow-ssh (0.0.0.0/0)
    â”œâ”€â”€ allow-http (0.0.0.0/0)
    â””â”€â”€ allow-internal (10.0.0.0/8)
```

### í”Œë ˆì´ìŠ¤í™€ë”

| ë³€ìˆ˜ | ì„¤ëª… | ì˜ˆì‹œ |
|------|------|------|
| `VPC_NAME` | VPC ì´ë¦„ | `pista-vpc` |
| `PUBLIC_SUBNET` | Public ì„œë¸Œë„· ì´ë¦„ | `pista-public-subnet` |
| `PRIVATE_SUBNET` | Private ì„œë¸Œë„· ì´ë¦„ | `pista-private-subnet` |
| `ROUTER_NAME` | Cloud Router ì´ë¦„ | `pista-router` |
| `NAT_NAME` | Cloud NAT ì´ë¦„ | `pista-nat` |
| `REGION` | ë¦¬ì „ | `asia-northeast3` |

### êµ¬í˜„ í”„ë¡œì„¸ìŠ¤

| ë‹¨ê³„ | ì‘ì—… | ìƒì„¸ ë‚´ìš© |
| :--- | :--- | :--- |
| **1** | **VPC ìƒì„±** | Custom Mode, Regional Routing |
| **2** | **ì„œë¸Œë„· ìƒì„±** | Public (10.0.1.0/24), Private (10.0.2.0/24) |
| **3** | **Router/NAT** | Cloud NATë¥¼ í†µí•œ Private ì„œë¸Œë„· ì¸í„°ë„· í—ˆìš© |
| **4** | **ë°©í™”ë²½ ê·œì¹™** | SSH(22), HTTP(80/443), Internal(All) |

**1ë‹¨ê³„: VPC ìƒì„±**

custom ëª¨ë“œë¡œ ìƒì„±í•˜ì—¬ ì„œë¸Œë„·ì„ ì§ì ‘ ì œì–´í•©ë‹ˆë‹¤.

```bash
gcloud compute networks create $VPC_NAME \
    --subnet-mode=custom \
    --bgp-routing-mode=regional
```

**2ë‹¨ê³„: ì„œë¸Œë„· ìƒì„±**

Public(ì™¸ë¶€ í†µì‹ ìš©)ê³¼ Private(ë‚´ë¶€ í†µì‹ ìš©) ì„œë¸Œë„·ì„ ìƒì„±í•©ë‹ˆë‹¤.

```bash
# Public Subnet
gcloud compute networks subnets create $PUBLIC_SUBNET \
    --network=$VPC_NAME \
    --region=$REGION \
    --range=10.0.1.0/24

# Private Subnet (Private IP Google Access í™œì„±í™”)
gcloud compute networks subnets create $PRIVATE_SUBNET \
    --network=$VPC_NAME \
    --region=$REGION \
    --range=10.0.2.0/24 \
    --enable-private-ip-google-access
```

**3ë‹¨ê³„: Cloud Router & NAT**

Private ì„œë¸Œë„·ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì¸í„°ë„·ìœ¼ë¡œ ì•„ì›ƒë°”ìš´ë“œ í†µì‹ (íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë“±)ì„ í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

```bash
# Cloud Router
create_if_not_exists \
    "gcloud compute routers describe $ROUTER_NAME --region=$REGION" \
    "gcloud compute routers create $ROUTER_NAME --network=$VPC_NAME --region=$REGION" \
    "Cloud Router"

# Cloud NAT
create_if_not_exists \
    "gcloud compute routers nats describe $NAT_NAME --router=$ROUTER_NAME --region=$REGION" \
    "gcloud compute routers nats create $NAT_NAME --router=$ROUTER_NAME --region=$REGION --nat-all-subnet-ip-ranges --auto-allocate-nat-external-ips" \
    "Cloud NAT"
```

**4ë‹¨ê³„: ë°©í™”ë²½ ê·œì¹™**

SSH, HTTP ì ‘ê·¼ ë° VPC ë‚´ë¶€ í†µì‹ ì„ í—ˆìš©í•©ë‹ˆë‹¤.

```bash
# SSH í—ˆìš©
create_if_not_exists \
    "gcloud compute firewall-rules describe $FW_SSH" \
    "gcloud compute firewall-rules create $FW_SSH --network=$VPC_NAME --allow=tcp:22 --source-ranges=0.0.0.0/0 --description='Allow SSH'" \
    "FW: SSH"

# HTTP í—ˆìš©
create_if_not_exists \
    "gcloud compute firewall-rules describe $FW_HTTP" \
    "gcloud compute firewall-rules create $FW_HTTP --network=$VPC_NAME --allow=tcp:80,tcp:443 --source-ranges=0.0.0.0/0 --target-tags=http-server" \
    "FW: HTTP"

# ë‚´ë¶€ í†µì‹  í—ˆìš©
create_if_not_exists \
    "gcloud compute firewall-rules describe $FW_INTERNAL" \
    "gcloud compute firewall-rules create $FW_INTERNAL --network=$VPC_NAME --allow=tcp:0-65535,udp:0-65535,icmp --source-ranges=10.0.0.0/8" \
    "FW: Internal"
```

---

## 2. VM ì¸ìŠ¤í„´ìŠ¤ êµ¬ì„± (Public + Private)

ë„¤íŠ¸ì›Œí¬ êµ¬ì„± í›„, ì‹¤ì œ ì›¹ ì„œë¹„ìŠ¤ë¥¼ ë‹´ë‹¹í•  VM ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°°ì¹˜í•©ë‹ˆë‹¤.

### ì•„í‚¤í…ì²˜

```
pista-vpc
â”œâ”€â”€ pista-public-subnet
â”‚   â””â”€â”€ pista-public-nginx (External IP ë³´ìœ , Bastion ì—­í• )
â””â”€â”€ pista-private-subnet
    â””â”€â”€ pista-private-nginx (Internal IP Only, ì™¸ë¶€ ì ‘ì† ë¶ˆê°€)
```

### êµ¬í˜„ í”„ë¡œì„¸ìŠ¤

| ë‹¨ê³„ | ì‘ì—… | ìƒì„¸ ë‚´ìš© |
| :--- | :--- | :--- |
| **1** | **ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰** | `bash gcp-vm-setup.sh` (Ubuntu 24.04 Minimal) |
| **2** | **ì ‘ì† í…ŒìŠ¤íŠ¸** | Public IP í™•ì¸, Private IP ë‚´ë¶€ í†µì‹  í™•ì¸ |

**1ë‹¨ê³„: ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰**

```bash
# OS: Ubuntu Minimal 24.04 LTS
bash gcp-vm-setup.sh
```

**2ë‹¨ê³„: ì ‘ì† í…ŒìŠ¤íŠ¸**

1. **Public VM**: `http://<PUBLIC_IP>`
2. **Private VM**: ì™¸ë¶€ IPê°€ ì—†ìœ¼ë¯€ë¡œ Public VMì„ ê²½ìœ í•˜ê±°ë‚˜ SSH í„°ë„ë§ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

### ğŸ”Œ Private VM ì ‘ì† ê°€ì´ë“œ

**ë°©ë²• 1: Bastion ê²½ìœ  (ê¸°ë³¸)**
```bash
# 1. Public VM ì ‘ì†
gcloud compute ssh pista-public-nginx --zone=asia-northeast3-a

# 2. ë‚´ë¶€ì—ì„œ Private VM í˜¸ì¶œ
curl http://10.0.2.x
```

**ë°©ë²• 2: SSH í„°ë„ë§ (Local Port Forwarding)**
ë‚´ PC(Mac)ì˜ ë¡œì»¬ í¬íŠ¸ë¥¼ í†µí•´ Private VMì˜ 80 í¬íŠ¸ì— ì§ì ‘ ì ‘ì†í•©ë‹ˆë‹¤.

```bash
# ë¡œì»¬ 8080 í¬íŠ¸ -> Private VM 80 í¬íŠ¸ ì—°ê²°
gcloud compute ssh pista-public-nginx --zone=asia-northeast3-a -- -L 8080:10.0.2.x:80
```
- **í™•ì¸**: ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:8080` ì ‘ì†

---

## 3. êµ¬ì¶• ìŠ¤í¬ë¦½íŠ¸

| ìŠ¤í¬ë¦½íŠ¸                     | ìš©ë„                                             | ì‹¤í–‰                            |
| ------------------------ | ---------------------------------------------- | ----------------------------- |
| `gcp-network-setup.sh`   | VPC, Subnet, Router, NAT, Firewall ìƒì„± (ìµœìš°ì„  ì‹¤í–‰) | `bash gcp-network-setup.sh`   |
| `gcp-network-cleanup.sh` | ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ ì‚­ì œ                                    | `bash gcp-network-cleanup.sh` |
| `gcp-vm-setup.sh`        | VM ì¸ìŠ¤í„´ìŠ¤ (Public/Private) ìƒì„±                    | `bash gcp-vm-setup.sh`        |
| `gcp-vm-cleanup.sh`      | VM ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ                                     | `bash gcp-vm-cleanup.sh`      |

---

## ê´€ë ¨ ë…¸íŠ¸
- [[GCP_MOC]]
- [[gcp-vm-ssh]] - SSH ìƒì„¸ ì ‘ì† ê°€ì´ë“œ
