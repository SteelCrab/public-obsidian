# GCP VPC 인프라 + MySQL 구축

#gcp #cloud #vpc #mysql #네트워크

---

## 1. VPC 인프라 구축 (VPC + Subnet + NAT + VM)

> AWS VPC + Public/Private Subnet + NAT Gateway + EC2 패턴과 동일

### 아키텍처

```
pista-vpc (Custom Mode)
├── pista-public-subnet (10.0.1.0/24)
│   └── public-nginx-server (e2-micro, External IP)
│
├── pista-private-subnet (10.0.2.0/24, Private Google Access)
│   ├── private-nginx-server (e2-micro, No External IP)
│   └── private-mysql-server (e2-small, MySQL 8.0)
│
├── Cloud Router → Cloud NAT (Private 아웃바운드)
│
└── 방화벽
    ├── allow-ssh: tcp:22 (0.0.0.0/0)
    ├── allow-http: tcp:80,443 → tag:http-server
    ├── allow-internal: all (10.0.0.0/8)
    └── allow-mysql: tcp:3306 → tag:mysql-server
```

### 플레이스홀더

| 변수 | 설명 | 예시 |
|------|------|------|
| `PROJECT_ID` | GCP 프로젝트 ID | `named-foundry-486921-r5` |
| `REGION` | 리전 | `asia-northeast1` |
| `ZONE` | 존 | `asia-northeast1-a` |
| `VPC_NAME` | VPC 이름 | `pista-vpc` |
| `PUBLIC_SUBNET` | 퍼블릭 서브넷 | `pista-public-subnet` |
| `PRIVATE_SUBNET` | 프라이빗 서브넷 | `pista-private-subnet` |
| `ROUTER_NAME` | Cloud Router | `pista-router` |
| `NAT_NAME` | Cloud NAT | `pista-nat` |

### 구현 프로세스

**1단계: VPC 생성**

```bash
gcloud compute networks create $VPC_NAME \
    --subnet-mode=custom \
    --bgp-routing-mode=regional
```

**2단계: Public 서브넷**

```bash
gcloud compute networks subnets create $PUBLIC_SUBNET \
    --network=$VPC_NAME \
    --region=$REGION \
    --range=10.0.1.0/24
```

**3단계: Private 서브넷**

```bash
gcloud compute networks subnets create $PRIVATE_SUBNET \
    --network=$VPC_NAME \
    --region=$REGION \
    --range=10.0.2.0/24 \
    --enable-private-ip-google-access
```

**4단계: Cloud Router**

```bash
gcloud compute routers create $ROUTER_NAME \
    --network=$VPC_NAME \
    --region=$REGION
```

**5단계: Cloud NAT (Private 아웃바운드)**

```bash
gcloud compute routers nats create $NAT_NAME \
    --router=$ROUTER_NAME \
    --region=$REGION \
    --nat-all-subnet-ip-ranges \
    --auto-allocate-nat-external-ips
    --nat-all-subnet-ip-ranges
```

**6단계: 방화벽 규칙**

```bash
# SSH
gcloud compute firewall-rules create allow-ssh-$VPC_NAME \
    --network=$VPC_NAME --allow=tcp:22 --source-ranges=0.0.0.0/0

# HTTP
gcloud compute firewall-rules create allow-http-$VPC_NAME \
    --network=$VPC_NAME --allow=tcp:80,tcp:443 \
    --source-ranges=0.0.0.0/0 --target-tags=http-server

# 내부 통신
gcloud compute firewall-rules create allow-internal-$VPC_NAME \
    --network=$VPC_NAME --allow=tcp:0-65535,udp:0-65535,icmp \
    --source-ranges=10.0.0.0/8
```

**7단계: Public VM (Nginx)**

```bash
gcloud compute instances create public-nginx-server \
    --zone=$ZONE \
    --machine-type=e2-micro \
    --subnet=$PUBLIC_SUBNET \
    --tags=http-server \
    --metadata=startup-script='#!/bin/bash
apt-get update && apt-get install -y nginx
systemctl start nginx'
```

**8단계: Private VM (Nginx)**

```bash
gcloud compute instances create private-nginx-server \
    --zone=$ZONE \
    --machine-type=e2-micro \
    --subnet=$PRIVATE_SUBNET \
    --no-address \
    --tags=http-server \
    --metadata=startup-script='#!/bin/bash
apt-get update && apt-get install -y nginx
systemctl start nginx'
```

**확인**

```bash
# Public 서버 외부 접속
PUBLIC_IP=$(gcloud compute instances describe public-nginx-server \
    --zone=$ZONE --format="value(networkInterfaces[0].accessConfigs[0].natIP)")
curl http://$PUBLIC_IP

# Public → Private 내부 통신 (Bastion 경유)
gcloud compute ssh public-nginx-server --zone=$ZONE
curl http://10.0.2.2  # Private 내부 IP
```

---

## 2. MySQL VM 구축

> Private 서브넷에 MySQL 8.0 설치 (Cloud SQL이 아닌 VM 직접 설치)

### 플레이스홀더

| 변수 | 설명 | 예시 |
|------|------|------|
| `MYSQL_VM` | MySQL VM 이름 | `private-mysql-server` |
| `DB_NAME` | 데이터베이스 이름 | `appdb` |
| `DB_USER` | DB 사용자 | `appuser` |
| `DB_PASSWORD` | DB 비밀번호 | `<CHANGE_ME>` |

### 구현 프로세스

**1단계: MySQL 방화벽**

```bash
gcloud compute firewall-rules create allow-mysql-$VPC_NAME \
    --network=$VPC_NAME \
    --allow=tcp:3306 \
    --source-ranges=10.0.0.0/8 \
    --target-tags=mysql-server
```

**2단계: MySQL VM 생성 + 설치**

```bash
gcloud compute instances create $MYSQL_VM \
    --zone=$ZONE \
    --machine-type=e2-small \
    --subnet=$PRIVATE_SUBNET \
    --no-address \
    --tags=mysql-server \
    --metadata=startup-script='#!/bin/bash
apt-get update && apt-get install -y mysql-server
sed -i "s/bind-address.*/bind-address = 0.0.0.0/" /etc/mysql/mysql.conf.d/mysqld.cnf
systemctl restart mysql
mysql -e "CREATE DATABASE IF NOT EXISTS '"$DB_NAME"' CHARACTER SET utf8mb4;"
mysql -e "CREATE USER IF NOT EXISTS '"$DB_USER"'"'"'"@'"'"'%'"'"' IDENTIFIED BY '"'"'$DB_PASSWORD'"'"';"
mysql -e "GRANT ALL ON '"$DB_NAME"'.* TO '"$DB_USER"'"'"'"@'"'"'%'"'"';"
mysql -e "FLUSH PRIVILEGES;"'
```

**확인 (Bastion 경유)**

```bash
# Public 서버로 SSH
gcloud compute ssh public-nginx-server --zone=$ZONE

# Public 서버에서 MySQL 접속
mysql -h <MYSQL_PRIVATE_IP> -u $DB_USER -p $DB_NAME
SHOW DATABASES;
```

---

## 3. 구축 스크립트

| 스크립트 | 용도 | 실행 |
|---------|------|------|
| `gcp-vm-setup.sh` | VPC + Subnet + NAT + 방화벽 + VM | `bash gcp-vm-setup.sh` |
| `gcp-vm-cleanup.sh` | VPC 인프라 리소스 정리 | `bash gcp-vm-cleanup.sh` |
| `gcp-mysql-setup.sh` | MySQL VM + 방화벽 | `bash gcp-mysql-setup.sh` |
| `gcp-mysql-cleanup.sh` | MySQL 리소스 정리 | `bash gcp-mysql-cleanup.sh` |

---

## 4. 리소스 정리

```bash
# VM 삭제
gcloud compute instances delete public-nginx-server private-nginx-server $MYSQL_VM \
    --zone=$ZONE --quiet

# 방화벽 삭제
gcloud compute firewall-rules delete \
    allow-ssh-$VPC_NAME allow-http-$VPC_NAME \
    allow-internal-$VPC_NAME allow-mysql-$VPC_NAME --quiet

# NAT → Router → 서브넷 → VPC 순서로 삭제
gcloud compute routers nats delete $NAT_NAME --router=$ROUTER_NAME --region=$REGION --quiet
gcloud compute routers delete $ROUTER_NAME --region=$REGION --quiet
gcloud compute networks subnets delete $PUBLIC_SUBNET $PRIVATE_SUBNET --region=$REGION --quiet
gcloud compute networks delete $VPC_NAME --quiet
```

---

## 관련 노트

- [GCP_MOC](./GCP_MOC.md)
